name: ä¾è³´æ›´æ–°æª¢æŸ¥

on:
  schedule:
    - cron: '0 0 * * 1'  # æ¯é€±ä¸€åˆå¤œåŸ·è¡Œ
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  update-dependencies:
    name: æª¢æŸ¥ä¸¦æ›´æ–°ä¾è³´
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout ç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: è¨­å®š Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: æª¢æŸ¥å¯æ›´æ–°çš„ä¾è³´
      run: |
        echo "## ç›®å‰ä¾è³´ç‹€æ³" > dependency-report.md
        go list -u -m all >> dependency-report.md
        
    - name: æ›´æ–°ä¾è³´
      run: |
        go get -u ./...
        go mod tidy

    - name: åŸ·è¡Œæ¸¬è©¦
      run: go test ./...

    - name: æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
      id: changes
      run: |
        if git diff --quiet go.mod go.sum; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
        fi

    - name: å‰µå»º Pull Request
      if: steps.changes.outputs.has_changes == 'true'
      uses: peter-evans/create-pull-request@v6
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "chore: æ›´æ–° Go ä¾è³´"
        title: "è‡ªå‹•æ›´æ–°ï¼šGo ä¾è³´å¥—ä»¶"
        body: |
          ## ğŸ“¦ ä¾è³´æ›´æ–°
          
          æ­¤ PR ç”±è‡ªå‹•åŒ–å·¥ä½œæµç¨‹å»ºç«‹ï¼ŒåŒ…å«æœ€æ–°çš„ Go ä¾è³´æ›´æ–°ã€‚
          
          ### è®Šæ›´å…§å®¹
          - æ›´æ–°æ‰€æœ‰å¯æ›´æ–°çš„ä¾è³´åˆ°æœ€æ–°ç‰ˆæœ¬
          - åŸ·è¡Œ `go mod tidy` æ¸…ç†æœªä½¿ç”¨çš„ä¾è³´
          
          ### æ¸¬è©¦çµæœ
          âœ… æ‰€æœ‰æ¸¬è©¦é€šé
          
          ### å¯©æŸ¥è¦é»
          - æª¢æŸ¥æ˜¯å¦æœ‰ç ´å£æ€§è®Šæ›´
          - ç¢ºèªæ¸¬è©¦è¦†è“‹ç‡æœªé™ä½
          - é©—è­‰åŠŸèƒ½æ­£å¸¸é‹ä½œ
          
          ---
          ğŸ¤– è‡ªå‹•ç”Ÿæˆæ–¼ ${{ github.run_number }}
        branch: auto-update-dependencies
        delete-branch: true
        labels: |
          dependencies
          automated
