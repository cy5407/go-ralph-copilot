name: ç™¼å¸ƒç‰ˆæœ¬

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  release:
    name: å»ºç½®ä¸¦ç™¼å¸ƒ
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout ç¨‹å¼ç¢¼
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: è¨­å®š Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: å–å¾—ç‰ˆæœ¬è™Ÿ
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

    - name: åŸ·è¡Œæ¸¬è©¦
      run: go test -v ./...

    - name: å»ºç½®æ‰€æœ‰å¹³å°
      run: |
        mkdir -p dist
        
        # Windows AMD64
        GOOS=windows GOARCH=amd64 go build -ldflags="-s -w -X main.Version=${{ steps.version.outputs.VERSION }}" -o dist/ralph-loop-windows-amd64.exe ./cmd/ralph-loop
        
        # Windows ARM64
        GOOS=windows GOARCH=arm64 go build -ldflags="-s -w -X main.Version=${{ steps.version.outputs.VERSION }}" -o dist/ralph-loop-windows-arm64.exe ./cmd/ralph-loop
        
        # Linux AMD64
        GOOS=linux GOARCH=amd64 go build -ldflags="-s -w -X main.Version=${{ steps.version.outputs.VERSION }}" -o dist/ralph-loop-linux-amd64 ./cmd/ralph-loop
        
        # Linux ARM64
        GOOS=linux GOARCH=arm64 go build -ldflags="-s -w -X main.Version=${{ steps.version.outputs.VERSION }}" -o dist/ralph-loop-linux-arm64 ./cmd/ralph-loop
        
        # macOS AMD64
        GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w -X main.Version=${{ steps.version.outputs.VERSION }}" -o dist/ralph-loop-darwin-amd64 ./cmd/ralph-loop
        
        # macOS ARM64 (M1/M2)
        GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w -X main.Version=${{ steps.version.outputs.VERSION }}" -o dist/ralph-loop-darwin-arm64 ./cmd/ralph-loop

    - name: å‰µå»ºå£“ç¸®æª”
      run: |
        cd dist
        
        # ç‚º Windows å‰µå»º ZIP
        zip ralph-loop-${{ steps.version.outputs.VERSION }}-windows-amd64.zip ralph-loop-windows-amd64.exe
        zip ralph-loop-${{ steps.version.outputs.VERSION }}-windows-arm64.zip ralph-loop-windows-arm64.exe
        
        # ç‚º Linux å’Œ macOS å‰µå»º tar.gz
        tar czf ralph-loop-${{ steps.version.outputs.VERSION }}-linux-amd64.tar.gz ralph-loop-linux-amd64
        tar czf ralph-loop-${{ steps.version.outputs.VERSION }}-linux-arm64.tar.gz ralph-loop-linux-arm64
        tar czf ralph-loop-${{ steps.version.outputs.VERSION }}-darwin-amd64.tar.gz ralph-loop-darwin-amd64
        tar czf ralph-loop-${{ steps.version.outputs.VERSION }}-darwin-arm64.tar.gz ralph-loop-darwin-arm64
        
        # åˆªé™¤åŸå§‹äºŒé€²ä½æª”æ¡ˆ
        rm -f *.exe ralph-loop-*
        ls -lh

    - name: è¨ˆç®—æª”æ¡ˆé›œæ¹Šå€¼
      run: |
        cd dist
        sha256sum *.zip *.tar.gz > checksums.txt
        cat checksums.txt

    - name: ç”Ÿæˆç™¼å¸ƒæ—¥èªŒ
      id: changelog
      run: |
        # å–å¾—å‰ä¸€å€‹æ¨™ç±¤
        PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
        
        if [ -z "$PREV_TAG" ]; then
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "## ğŸ‰ é¦–æ¬¡ç™¼å¸ƒ" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "é€™æ˜¯ Ralph Loop çš„é¦–æ¬¡æ­£å¼ç™¼å¸ƒç‰ˆæœ¬ï¼" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "## ğŸ“ è®Šæ›´æ—¥èªŒ" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        fi

    - name: å‰µå»º GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ steps.version.outputs.VERSION }}
        body: |
          # Ralph Loop ${{ steps.version.outputs.VERSION }}
          
          ${{ steps.changelog.outputs.CHANGELOG }}
          
          ## ğŸ“¦ ä¸‹è¼‰èˆ‡å®‰è£
          
          ### Windows
          ä¸‹è¼‰å°æ‡‰ç‰ˆæœ¬ï¼š
          - **AMD64**: `ralph-loop-${{ steps.version.outputs.VERSION }}-windows-amd64.zip`
          - **ARM64**: `ralph-loop-${{ steps.version.outputs.VERSION }}-windows-arm64.zip`
          
          è§£å£“ç¸®å¾Œå°‡ `ralph-loop.exe` æ”¾åˆ°ç³»çµ± PATH ä¸­ã€‚
          
          ### Linux
          ```bash
          # AMD64
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/ralph-loop-${{ steps.version.outputs.VERSION }}-linux-amd64.tar.gz
          tar xzf ralph-loop-${{ steps.version.outputs.VERSION }}-linux-amd64.tar.gz
          chmod +x ralph-loop-linux-amd64
          sudo mv ralph-loop-linux-amd64 /usr/local/bin/ralph-loop
          ```
          
          ### macOS
          ```bash
          # Apple Silicon (M1/M2/M3)
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/ralph-loop-${{ steps.version.outputs.VERSION }}-darwin-arm64.tar.gz
          tar xzf ralph-loop-${{ steps.version.outputs.VERSION }}-darwin-arm64.tar.gz
          chmod +x ralph-loop-darwin-arm64
          sudo mv ralph-loop-darwin-arm64 /usr/local/bin/ralph-loop
          
          # Intel
          wget https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.VERSION }}/ralph-loop-${{ steps.version.outputs.VERSION }}-darwin-amd64.tar.gz
          tar xzf ralph-loop-${{ steps.version.outputs.VERSION }}-darwin-amd64.tar.gz
          chmod +x ralph-loop-darwin-amd64
          sudo mv ralph-loop-darwin-amd64 /usr/local/bin/ralph-loop
          ```
          
          ## ğŸ”’ é©—è­‰æª”æ¡ˆå®Œæ•´æ€§
          
          ä¸‹è¼‰ `checksums.txt` ä¸¦é©—è­‰ï¼š
          ```bash
          sha256sum -c checksums.txt
          ```
          
          ## ğŸ“š æ–‡æª”
          
          - [README.md](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.VERSION }}/README.md)
          - [USAGE_GUIDE.md](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.VERSION }}/USAGE_GUIDE.md)
          - [DEPLOYMENT_GUIDE.md](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.VERSION }}/DEPLOYMENT_GUIDE.md)
          
          ## ğŸ› å›å ±å•é¡Œ
          
          å¦‚æœ‰ä»»ä½•å•é¡Œï¼Œè«‹åœ¨ [Issues](https://github.com/${{ github.repository }}/issues) å›å ±ã€‚
        files: |
          dist/*.zip
          dist/*.tar.gz
          dist/checksums.txt
        draft: false
        prerelease: ${{ contains(steps.version.outputs.VERSION, 'rc') || contains(steps.version.outputs.VERSION, 'beta') || contains(steps.version.outputs.VERSION, 'alpha') }}
        token: ${{ secrets.GITHUB_TOKEN }}

  docker:
    name: å»ºç½®ä¸¦æ¨é€ Docker æ˜ åƒ
    runs-on: ubuntu-latest
    needs: release
    
    steps:
    - name: Checkout ç¨‹å¼ç¢¼
      uses: actions/checkout@v4

    - name: è¨­å®š Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ç™»å…¥ Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
      if: github.event_name != 'pull_request'

    - name: æå– Docker å…ƒæ•¸æ“š
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ secrets.DOCKER_USERNAME }}/ralph-loop
        tags: |
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=raw,value=latest,enable={{is_default_branch}}

    - name: å»ºç½®ä¸¦æ¨é€ Docker æ˜ åƒ
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
