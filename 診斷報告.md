# Ralph Loop 卡住問題診斷報告

## 問題描述

當透過 copilot CLI 對話框請 AI 運行無限迭代程式時，程式發生卡住的狀況。

## 根本原因分析

### 1. CLI 執行器進入交互式模式 ⭐ 最可能的原因

**位置**: `internal/ghcopilot/cli_executor.go:382`

**問題**:
- `copilot` CLI 可能進入交互式模式，等待使用者輸入
- 沒有設定 `cmd.Stdin = nil`，導致程式等待標準輸入
- 缺少環境變數強制非交互式模式

**修復**: ✅ 已修復
```go
// 設定環境變數 - 強制非交互式模式
cmd.Env = append(os.Environ(),
    fmt.Sprintf("REQUEST_ID=%s", ce.requestID),
    "COPILOT_NONINTERACTIVE=1",           // 防止交互式提示
    "GITHUB_COPILOT_CLI_SKIP_PROMPTS=1", // 跳過所有提示
)
cmd.Stdin = nil // 明確設定沒有輸入
```

### 2. SDK 執行器初始化時卡住

**位置**: `internal/ghcopilot/sdk_executor.go:99`

**問題**:
- `e.client.Start()` 可能在等待 copilot CLI 回應
- 初始化時沒有進度輸出

**修復**: ✅ 已修復
- 延遲啟動 SDK 執行器（僅在需要時啟動）
- 當前實作使用 CLIExecutor，SDK 執行器是備用選項

### 3. 缺少進度輸出

**位置**: `cmd/ralph-loop/main.go:149`

**問題**:
- 執行過程沒有實時輸出
- 用戶無法判斷程式是在執行還是卡住

**修復**: ✅ 已修復
```go
// 在每個迴圈顯示進度
fmt.Printf("\n🔄 迴圈 %d/%d - 正在執行...\n", i+1, maxLoops)
```

### 4. 超時設定可能不足

**位置**: `cmd/ralph-loop/main.go:24` 和 `internal/ghcopilot/cli_executor.go:86`

**問題**:
- CLI 執行超時預設 30 秒
- 總執行超時預設 5 分鐘
- 對於複雜任務可能不足

**建議**: 可根據需要調整

## 測試建議

### 測試 1: 驗證 CLI 非交互式模式

```bash
# 測試 copilot CLI 是否正常運行
copilot -p "列出當前目錄的檔案" -s --allow-all-tools --no-ask-user
```

### 測試 2: 啟用除錯模式

```bash
# 設定環境變數啟用除錯
$env:COPILOT_MOCK_MODE="true"
.\ralph-loop.exe run -prompt "修正編譯錯誤" -max-loops 3
```

### 測試 3: 檢查 copilot CLI 版本

```bash
copilot --version
# 預期: 0.0.389 或更高版本
```

### 測試 4: 測試基本功能

```bash
# 建置程式
go build -o ralph-loop.exe ./cmd/ralph-loop

# 測試基本執行（使用較短的超時）
.\ralph-loop.exe run -prompt "測試提示" -max-loops 1 -timeout 1m
```

## 後續追蹤

### 如果問題仍存在，請檢查：

1. **Copilot CLI 認證狀態**
   ```bash
   copilot --help
   # 確認是否需要登入
   ```

2. **網路連接問題**
   - Copilot CLI 需要網路連接到 GitHub API
   - 檢查防火牆設定

3. **工作目錄權限**
   ```bash
   # 確認工作目錄可寫入
   echo "test" > test.txt
   ```

4. **啟用詳細日誌**
   修改 `cli_executor.go` 添加詳細日誌：
   ```go
   cmd.Env = append(os.Environ(),
       "COPILOT_DEBUG=1",
       "COPILOT_LOG_LEVEL=debug",
   )
   ```

## 修復摘要

✅ 已修復的問題：
1. CLI 執行器強制非交互式模式
2. 設定 `cmd.Stdin = nil` 防止等待輸入
3. 添加進度輸出到 ExecuteUntilCompletion
4. 延遲 SDK 執行器啟動
5. 添加診斷資訊

⚠️ 需要測試：
1. 重新編譯並測試
2. 驗證 copilot CLI 是否正常工作
3. 確認網路連接和認證

## 建議的測試步驟

1. 重新編譯程式
   ```bash
   go build -o ralph-loop.exe ./cmd/ralph-loop
   ```

2. 測試簡單任務
   ```bash
   .\ralph-loop.exe run -prompt "列出 go.mod 的內容" -max-loops 1 -timeout 30s
   ```

3. 監控輸出
   - 應該看到進度訊息
   - 如果卡住，按 Ctrl+C 檢查日誌

4. 如果仍然卡住
   - 設定 `$env:COPILOT_MOCK_MODE="true"` 使用模擬模式測試
   - 檢查 copilot CLI 是否能單獨運行
