# Reminder - 202602231833

## 主題：AI 終止信號偵測的三層防禦策略

---

## 問題描述

ralph-loop 依賴 Copilot 輸出 `---RALPH_STATUS---` 區塊來判斷任務是否完成。
但實際執行中，Copilot **從不輸出這個格式**，導致即使任務已完成，loop 仍繼續執行。

---

## 根本原因

1. **解析過於嚴格**：`ParseStructuredOutput` 用 `strings.HasPrefix(line, "EXIT_SIGNAL:")` 比對，若 Copilot 輸出有縮排（例如 `   EXIT_SIGNAL: true`）就比對不到
2. **Windows CRLF 問題**：regex `\n` 無法匹配 Windows 的 `\r\n`，可能導致區塊解析失敗
3. **Copilot 不遵守格式**：即使 prompt 要求輸出格式，Copilot 仍傾向用自然語言（markdown 表格、純文字結論）

---

## 建議修法（三層防禦）

### Layer 1：修 ParseStructuredOutput（讓解析容錯）

```go
// 解析每行時先 TrimSpace，處理縮排與 CRLF
lines := strings.Split(strings.ReplaceAll(block, "\r\n", "\n"), "\n")
for _, line := range lines {
    line = strings.TrimSpace(line)  // 這行已有，但 block 提取前也要處理
    ...
}

// regex 也要容許 \r\n
pattern := `(?s)---(?:COPILOT_STATUS|RALPH_STATUS)---\r?\n(.*?)\r?\n---END(?:_STATUS|_RALPH_STATUS)---`
```

### Layer 2：加強自然語言完成偵測（EXIT_SIGNAL 缺席時的備用）

在 `CalculateCompletionScore` 新增更多「任務不需要做」的關鍵字：

```go
noActionPatterns := []string{
    // 中文
    "不需要更新", "無需更新", "無需修改", "不需要 push", "無需 push",
    "已是最新", "已完整", "狀態良好", "無需任何",
    "不需要 git push", "無需 git push",
    // 英文
    "no update needed", "no changes needed", "up to date",
    "nothing to push", "no action required",
}
// 給這類「任務不需要做」+30分，超過 threshold 也能判定完成
```

### Layer 3：放寬 IsCompleted() 條件（最重要）

```go
func (ra *ResponseAnalyzer) IsCompleted() bool {
    status := ra.ParseStructuredOutput()

    // 優先：有明確 EXIT_SIGNAL=true 就直接完成，不需要第二條件
    if status != nil && status.ExitSignal {
        return true
    }

    // 備用：無結構化輸出，但自然語言分數夠高（≥ 30）且有 2 個指標
    if ra.completionScore >= 30 && len(ra.completionIndicators) >= 2 {
        return true
    }

    return false
}
```

---

## 優先順序

| 層 | 改動檔案 | 優先 | 說明 |
|----|---------|------|------|
| Layer 3 | `response_analyzer.go` IsCompleted() | **P0 立刻做** | 放寬條件，EXIT_SIGNAL 單獨夠用 |
| Layer 1 | `response_analyzer.go` ParseStructuredOutput() | P0 | 修 regex CRLF + TrimSpace |
| Layer 2 | `response_analyzer.go` CalculateCompletionScore() | P1 | 補自然語言備用關鍵字 |

---

## 預期效果

- Copilot 有輸出 `---RALPH_STATUS---` EXIT_SIGNAL: true → Layer 1+3 偵測到，立刻停止
- Copilot 沒輸出格式，只說「不需要更新」→ Layer 2+3 偵測到，停止
- Copilot 忽略所有要求，輸出純 markdown 表格 → Layer 2 的自然語言分數決定

---

## 目前狀態

- ✅ Prompt 開頭已注入格式要求
- ✅ CRLF regex 已部分處理
- ❌ Layer 3 IsCompleted() 仍要求 2 個指標 **（待修）**
- ❌ Layer 2 自然語言關鍵字不夠完整 **（待修）**
- ❌ Layer 1 ParseStructuredOutput CRLF 細節 **（待確認）**
